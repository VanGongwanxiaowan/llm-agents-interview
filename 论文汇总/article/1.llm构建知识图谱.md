https://medium.com/data-science/building-knowledge-graphs-with-llm-graph-transformer-a91045c49b59



# 网页总结：使用LLM图转换器构建知识图谱
本文由Tomaz Bratanic撰写，发布于TDS Archive，聚焦LangChain中LLM Graph Transformer（LLM图转换器）的实现，详细介绍其从文本构建知识图谱的方法、环境配置、核心功能及应用，旨在为检索增强生成（RAG）等场景提供结构化数据支持。


## 一、核心背景与价值
1. **核心任务**：将非结构化文本转换为包含“实体-关系”的结构化知识图谱，解决传统文本嵌入模型在**复杂多跳问题**（需理解多实体关联）和**结构化操作需求**（筛选、排序、聚合）上的不足。
2. **技术起源**：作者约一年前开始探索用LLM构建图谱，后将该能力整合进LangChain，形成LLM Graph Transformer工具，代码已开源至GitHub。
3. **核心价值**：为RAG应用提供更强支撑，提升信息检索的准确性与可扩展性，同时清晰呈现实体间复杂关系。


## 二、环境搭建：Neo4j图形数据库配置
LLM Graph Transformer需依赖Neo4j存储图谱，支持两种部署方式：
1. **云实例（推荐入门）**：使用免费的Neo4j Aura，无需本地安装，直接获取云数据库链接。
2. **本地实例**：下载Neo4j Desktop应用，创建本地数据库。
3. **LangChain连接代码示例**：
```python
from langchain_community.graphs import Neo4jGraph
graph = Neo4jGraph(    
    url="bolt://54.87.130.140:7687",    
    username="neo4j",    
    password="cables-anchors-directories",    
    refresh_schema=False
)
```


## 三、LLM Graph Transformer核心功能：双提取模式
LLM图转换器支持两种独立模式，适配不同LLM能力（是否支持工具/函数调用），确保兼容性与灵活性。

### 1. 基于工具的模式（默认，推荐）
- **适用场景**：LLM支持结构化输出或函数调用（如GPT-4o、OpenAI系列模型）。
- **核心逻辑**：
  - 利用LLM内置的`with_structured_output`功能，通过预定义工具规范输出格式，无需大量提示词工程。
  - 定义`Node`（节点）、`Relationship`（关系）、`Property`（属性）三类Pydantic类，约束数据结构：
    - `Node`：包含`id`（实体名，人类可读唯一标识）、`label`（实体类型，如Person/Organization）、`properties`（可选属性，键值对）。
    - `Relationship`：采用“扁平化设计”（避免嵌套降低准确性），包含`source_node_id/label`（源节点）、`target_node_id/label`（目标节点）、`type`（关系类型）、`properties`（可选属性）。
    - `Property`：键值对结构，支持为节点/关系添加额外信息（如“出生日期”“任职时间”）。
- **局限性**：暂不支持自定义函数或参数描述。

### 2. 基于提示词的模式（备用）
- **适用场景**：LLM不支持工具调用（如部分开源模型），或主动设置`ignore_tools_usage=True`强制启用。
- **核心逻辑**：
  - 依赖“少样本提示”定义输出格式，引导LLM以文本形式提取关系（仅提取关系，无孤立节点），再通过自定义函数转换为JSON格式。
  - 提示词包含系统指令（如“实体一致性要求”“JSON输出结构”）和示例（如从“Adam在微软工作”提取`(Adam, WORKS_FOR, Microsoft)`）。
- **局限性**：不支持属性提取，且需手动修改`prompt`属性自定义规则，暂不支持添加个性化少样本示例。


## 四、图模式定义：提升提取一致性
无预定义模式时，LLM会自主决定提取内容，导致输出不稳定（如同一文本两次提取可能出现“WINNER”“WON”两种关系表述）。通过定义模式可显著提升一致性，分为三个层次：

### 1. 定义允许的节点类型（allowed_nodes）
- **作用**：约束LLM仅提取指定类型的实体（如Person/Organization/Award/ResearchField），避免无关实体干扰。
- **代码示例**：
```python
allowed_nodes = ["Person", "Organization", "Location", "Award", "ResearchField"]
nodes_defined = LLMGraphTransformer(llm=llm, allowed_nodes=allowed_nodes)
```

### 2. 定义允许的关系类型（allowed_relationships）
- **基础方式**：用字符串列表定义关系（如["SPOUSE", "AWARD", "WORKS_AT"]），但无法约束关系连接的节点类型。
- **进阶方式（推荐）**：用三元组`(源节点类型, 关系类型, 目标节点类型)`定义（如`("Person", "SPOUSE", "Person")`），同时约束关系方向与连接节点，进一步降低输出差异。
- **代码示例**：
```python
allowed_relationships = [
    ("Person", "SPOUSE", "Person"),
    ("Person", "AWARD", "Award"),
    ("Person", "WORKS_AT", "Organization")
]
rels_defined = LLMGraphTransformer(llm=llm, allowed_nodes=allowed_nodes, allowed_relationships=allowed_relationships)
```

### 3. 定义属性（node_properties/relationship_properties）
- **两种配置方式**：
  - 自动提取：设为`True`，让LLM自主判断并提取相关属性（如玛丽·居里的“生卒日期”）。
  - 手动指定：用列表定义需提取的属性（如`node_properties=["birth_date", "death_date"]`），精准控制提取内容。
- **局限性**：仅支持工具模式提取，属性均为字符串类型，且无法按节点/关系类型单独定义属性。

### 4. 严格模式（strict_mode）
- **作用**：后处理步骤，移除不符合预定义模式的节点/关系（如未在`allowed_nodes`中的实体），默认开启（`strict_mode=True`）；关闭后LLM可能生成模式外内容。


## 五、图谱导入Neo4j的三种方式
通过`add_graph_documents`方法将提取的GraphDocument导入Neo4j，支持三种配置以适配不同需求：

| 导入方式 | 核心逻辑 | 适用场景 | 代码示例 |
|----------|----------|----------|----------|
| 默认导入 | 直接导入所有节点与关系 | 快速验证提取结果，无需额外元数据 | `graph.add_graph_documents(graph_documents)` |
| 基础实体标签（baseEntityLabel） | 为每个节点添加额外`__Entity__`标签 | 优化索引（Neo4j索引需绑定特定标签），提升检索效率 | `graph.add_graph_documents(graph_documents, baseEntityLabel=True)` |
| 包含源文档（include_source） | 导入节点/关系对应的源文档，用`MENTIONS`关系关联 | 追踪实体来源，支持“结构化+非结构化”混合检索 | `graph.add_graph_documents(graph_documents, include_source=True)` |


## 六、总结与扩展资源
1. **核心结论**：
   - 工具模式是主选，支持属性提取且无需复杂提示词；提示词模式为备用，无孤立节点但功能受限。
   - 预定义图模式（节点、关系、属性）是提升提取一致性的关键，严格模式可进一步保障输出合规性。
   - 图谱结合Neo4j可实现可视化与高效检索，为RAG、多跳查询提供强支撑。
2. **扩展资源**：
   - 代码开源：可在GitHub获取完整实现。
   - 无代码试用：通过Neo4j托管的“LLM Graph Builder”（llm-graph-builder.neo4jlabs.com）在线体验。
   - 测试数据：文中以玛丽·居里维基百科段落+罗宾·威廉姆斯补充句为例，演示不同模式下的提取效果。
