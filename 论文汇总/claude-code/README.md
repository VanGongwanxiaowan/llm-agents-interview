# Claude Code：一项分析报告

💡

本报告全文由 Claude Opus 4 生成，并得到了几乎所有主流旗舰模型的协助。不过，关于本报告制作过程的 8000 字说明文档是手动撰写的——你可以从这里开始阅读：[🕹️ 运用比我更智能的系统：新型协同模式]()

需要说明的是，从真正意义上讲，这并非一次真正的反编译或逆向工程尝试，更多是对 Claude 团队出色工作的致敬。文中提供的示例均不保证源自 Claude Code（或直接从源代码推导/复制）——其核心目的是通过传授新方法，帮助读者学习如何协同 AI 智能体。

（快速提示：感谢所有指出内容幻觉问题的人，但这些幻觉是故意保留的，作为生成过程的产物。那份“制作说明”将帮助我们理解幻觉产生的原因，而且在我看来，它们对于理解如何构建智能体系统同样具有重要价值！）

如果你想阅读最具信息量的部分，可从[✨ 创新组件：定义 Claude Code 的核心技术突破]()开始。

如果你想阅读最有趣的部分，可从[🤖 大语言模型的视角：接收这些指令究竟是什么体验]()开始。

✉️

### 我的一点说明

这个项目始于一个简单的好奇心。我想深入了解 Claude Code——在我看来，它是目前最优秀的智能体编程工具（尽管同类工具的竞争也十分激烈）。最初，我以为它的原理很简单，无非是一个大语言模型（LLM）加上几个循环运行的工具。但我错了。事实证明，它的复杂度远超预期，包含了许多我此前从未想到的创新组件。

为了完成这项分析，我与多个 AI 子智能体合作，让它们分别处理不同的推理任务。我手动传递问题与见解、审查输出内容以排查幻觉，并反复验证结果。

整个过程包括：

- 五组实验，每组包含四轮测试，且每轮均使用全新的子智能体（主要是 Gemini 2.5 Pro）
- 生成约 30 万个 Token 的中间分析内容
- 将所有内容浓缩为一份全面的报告

值得一提的是，整个过程仅用了一天时间，且让我收获颇丰。在大语言模型出现之前，这类分析即便可行，也需要耗费数月时间。在此，我要向 Opus 4 表示感谢——它将我浓缩后的报告转化为了你即将阅读的这份详尽分析！

——赫里希（Hrishi）

### 为何 Claude Code 意义重大

Claude Code 包含多个极具亮点的部分：

- **流式架构**：可处理实时 LLM 响应、工具执行与界面更新
- **安全系统**：在不中断工作流的前提下保障安全性
- **工具设计**：巧妙衔接 AI 推理与系统执行过程
- **提示工程**：可靠地控制复杂 LLM 的行为

接下来，让我们逐一深入探讨！每个标题均为指向完整章节的链接。

### [🔖 依赖项：Claude Code 架构的基石]()

为何要在终端中使用 React？yoga-layout 在此处有何作用？

本文将带你了解那些助力 Claude Code 实现出色性能的“非常规”依赖项选择。你将学习到：可在 bash 命令中嵌入 JSON 的自定义 Shell 解析器、用于处理部分 LLM 响应的流式 JSON 解析器，以及源自移动开发领域的应用无响应（ANR）检测系统。

### [📊 数据结构与信息架构]()

信息在系统中如何流转？

跟随数据从用户输入，到 LLM 处理，再到工具执行的完整路径。理解三阶段消息表示法、ContentBlock 多态性，以及弱引用如何避免内存膨胀问题。

**核心洞见**：CliMessage 包装器在维护界面（UI）状态的同时，还能保持 API 兼容性——无需修改协议，即可实现丰富的交互功能。

### [🔄 控制流与协同引擎]()

深入探索 tt 函数内部机制

本文将剖析负责协同所有流程的六阶段异步生成器。你将了解并行工具执行的工作原理、上下文压缩为何会自动触发，以及递归循环如何实现无限深度的对话。

**核心洞见**：工具会按“副作用”分类——只读工具可并行运行，而写入操作则需序列化处理，以保障安全性。

### [🛠️ 工具与执行引擎]()

从 LLM 决策到系统操作的落地

每个工具都是一个精心设计的状态机。本文将详细分析权限系统、进度报告与错误处理机制，并重点介绍 BashTool 的沙箱模式与 EditTool 的行号处理功能。

**核心洞见**：AgentTool 实现了层级化任务分解——可生成子智能体，并对其输出结果进行整合。

### [🏗️ 架构：核心运行机制]()

事件驱动、流式优先、安全为先

理解从 React 界面到系统调用的分层架构。学习权限如何在不同作用域中传递、应用无响应（ANR）检测为何使用工作线程，以及三个遥测系统如何实现全面的可观测性。

**核心洞见**：安全并非依赖单一系统——而是由多个独立层级构成，且各层级均具备“安全失效”能力（即某一层级失效时，不会导致整体安全体系崩溃）。

### [✨ 创新组件：定义 Claude Code 的核心技术突破]()

针对复杂问题的巧妙解决方案

探索让 Claude Code 脱颖而出的关键组件：具备恢复功能的流式 JSON 解析、智能数据截断，以及多智能体结果整合。这些并非简单的功能叠加——而是针对核心挑战的创新性解决方案。

**核心洞见**：normalizeToSize 算法会根据实际字节数，迭代降低对象深度——在满足约束条件的同时，最大限度保留信息。

### [✏️ 文件编辑：AI 辅助的代码修改功能]()

为何需要三种不同的编辑工具？

深入剖析文件编辑流程。了解行号为何会引发问题、顺序编辑如何检测冲突，以及当文件被外部修改时系统会如何处理。

**核心洞见**：针对所有可预见的编辑错误，系统都设有专门的验证机制——从外部修改到编码问题，均已覆盖。

### [💬 提示工程：指导 AI 的艺术]()

让一切得以运转的关键指令

剖析用于控制 Claude Code 的实际提示内容。从简洁性要求，到超过 500 词的 BashTool 安全说明——看看精准的措辞如何塑造 AI 的行为。

**核心洞见**：重复是有效的策略——关键指令会以递进式强调的方式，出现三次。

### [🤖 大语言模型的视角：接收这些指令究竟是什么体验]()

从“另一端”看，这些提示是什么感觉？

在这一独特章节中，作为大语言模型的“我”，将坦诚分享接收这些指令的体验。例如，“只需输出 4”为何出人意料地困难，以及“罚款 1000 美元”的设定——尽管是虚拟金额——为何能切实改变行为。

**核心洞见**：清晰的约束实则是一种“解放”——它能避免决策瘫痪与过度辅助（即因试图提供更多帮助而偏离核心任务）。

### 技术主题

纵观整个分析，可提炼出以下几项设计原则：

- **流式优先**：所有操作均为增量更新设计
- **分层安全**：多重独立的保护机制
- **指令明确**：详细的提示可避免模糊行为
- **架构优于优化**：通过设计实现性能提升，而非依赖后期调整
- **理解 LLM 心理**：利用模型的实际行为模式

### 章节导航

[🔖 依赖项：Claude Code 架构的基石]()

[📊 数据结构与信息架构]()

[🔄 控制流与协同引擎]()

[🛠️ 工具与执行引擎]()

[🏗️ 架构：核心运行机制]()

[✨ 创新组件：定义 Claude Code 的核心技术突破]()

[✏️ 文件编辑：AI 辅助的代码修改功能]()

[💬 提示工程：指导 AI 的艺术]()

[🤖 大语言模型的视角：接收这些指令究竟是什么体验]()

能实现这样的分析——更不用说在如此短的时间内完成——本身就令人惊叹。我无法保证报告中的所有内容都完全准确（或许 Claude 团队能给出权威解读），但这份报告的参考价值与指导意义是毋庸置疑的。

### 分析过程

[🕹️ 运用比我更智能的系统：新型协同模式]()
