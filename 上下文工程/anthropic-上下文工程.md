https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents

# Effective context engineering for AI agents - 网页总结
## 一、核心概念与定位
1. **上下文工程定义**：指在大语言模型（LLM）推理过程中，筛选和维护最优标记（信息）集的策略集合，涵盖提示之外可能纳入的所有信息，核心是在LLM固有约束下优化标记效用，以持续实现预期结果，需结合上下文思考LLM的整体状态及潜在行为。
2. **与提示工程的关系**：上下文工程是提示工程的自然演进。提示工程聚焦于编写和组织LLM指令（如优化一次性分类或文本生成任务的提示），而上下文工程针对多轮推理、长期运行的智能体，需管理整个上下文状态（系统指令、工具、外部数据、消息历史等），且是迭代过程，每次向模型传递信息时都需进行筛选，不同于提示工程的离散任务属性。

## 二、上下文工程的重要性
1. **LLM的固有局限**：LLM存在“上下文衰减”现象，即上下文窗口中标记数量增加时，模型准确回忆信息的能力下降；且LLM有“注意力预算”，类似人类有限的工作记忆，新标记会消耗预算，需谨慎筛选标记。
2. **技术层面约束**：LLM基于Transformer架构，标记间呈n² pairwise关系，上下文长度增加会导致模型捕捉这种关系的能力减弱，存在上下文大小与注意力聚焦的天然矛盾；同时，模型训练数据中短序列更常见，对长上下文依赖的处理经验和专用参数不足，虽有位置编码插值等技术适配长序列，但会损失标记位置理解精度。

## 三、有效上下文的构成要素
1. **系统提示**
    - 需清晰、语言简洁直接，内容深度要适中，避免过度硬编码复杂逻辑（导致脆弱性和维护复杂）或提供模糊高层指导（缺乏具体信号），要平衡特异性与灵活性。
    - 建议按`<background_information>`、`<instructions>`等不同部分组织，用XML标记或Markdown标题划分，且以“最小信息量完整勾勒预期行为”为目标，可先测试最小提示，再根据初始测试失败模式补充指令和示例。
2. **工具**
    - 工具是智能体与环境交互、获取新上下文的关键，需提升效率，返回标记高效的信息并促进智能体高效行为。
    - 工具应功能明确、低重叠、独立且抗错误，输入参数需描述清晰、无歧义；避免工具集臃肿导致功能冗余或选择模糊，同时推荐结合少样本提示提供示例，但需精选多样、典型示例，而非堆砌边缘案例。

## 四、上下文检索与智能体搜索
1. **智能体定义**：LLM自主循环使用工具的系统，模型能力越强，智能体自主性越高，可独立应对复杂问题和恢复错误。
2. **上下文检索策略**
    - **即时检索**：智能体维护轻量级标识符（文件路径、网页链接等），运行时通过工具动态加载数据到上下文，无需预先处理所有数据，类似人类按需检索信息，Anthropic的Claude Code即采用此策略分析大型数据库。
    - **混合检索**：结合预先检索（提升速度）和自主探索（按需深入），如Claude Code将[CLAUDE.md]文件预先纳入上下文，同时用glob、grep等工具即时检索文件，适用于法律、金融等内容动态性低的场景。
3. **即时检索的优势与挑战**：优势是存储高效，且标识符元数据（文件夹层级、命名规则、时间戳）能辅助智能体理解信息用途和使用时机，还支持渐进式披露（智能体逐步探索发现相关上下文）；挑战是运行时探索比预计算数据检索慢，且需合理设计工具和启发式规则，避免智能体滥用工具、陷入死胡同或遗漏关键信息。

## 五、长周期任务的上下文工程技术
1. **压缩（Compaction）**：当对话接近上下文窗口限制时，总结内容并以总结启动新上下文窗口，核心是高保真提炼关键信息，如Claude Code总结消息历史，保留架构决策、未解决漏洞等，丢弃冗余工具输出，同时可优先清除早期工具调用结果，实施时需平衡召回率（捕捉所有相关信息）和精确率（剔除多余内容）。
2. **结构化笔记（Structured Note - taking）**：智能体定期将笔记存储到上下文窗口外的内存，后续按需拉回上下文，能以低开销实现持久记忆，如Claude玩Pokémon时记录游戏步骤、地图、战斗策略等，Anthropic在Sonnet 4.5版本推出文件式内存工具，助力智能体积累知识库、跨会话维护项目状态。
3. **子智能体架构（Sub - agent architectures）**：由主智能体统筹全局计划，专用子智能体处理聚焦任务（拥有独立干净的上下文窗口），子智能体深入探索后仅返回精简总结（通常1000 - 2000标记），实现关注点分离，在复杂研究任务上比单智能体系统表现更优。
4. **技术选择依据**：压缩适用于需大量交互、保持对话流畅的任务；结构化笔记适合有明确里程碑的迭代开发；子智能体架构适用于需并行探索的复杂研究分析任务。

## 六、结论与实践建议
1. **核心原则**：上下文工程是LLM应用的范式转变，核心是筛选“最小高信号标记集”以最大化预期结果概率，需始终将上下文视为有限珍贵资源。
2. **未来趋势**：随着模型能力提升，智能体对预设工程的依赖降低，自主性增强，但上下文管理仍是构建可靠高效智能体的关键。
3. **实践入口**：可在Claude开发者平台开展上下文工程实践，通过“内存与上下文管理”手册获取最佳实践。

## 七、其他信息
1. **作者与致谢**：由Anthropic应用AI团队（Prithvi Rajasekaran、Ethan Dixon等）撰写，Rafi Ayub等团队成员提供支持，Molly Vorwerck等人致谢。
2. **附加资源**：提供开发者通讯订阅（含产品更新、使用指南等），并列出Anthropic的产品（Claude、Claude Code等）、模型（Opus、Sonnet等）、解决方案（AI智能体、代码现代化等）及Claude开发者平台相关入口。
