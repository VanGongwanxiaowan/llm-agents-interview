https://rlancemartin.github.io/2025/06/23/context_engineering/

# 《Context Engineering for Agents（智能体的语境工程）》网页总结
## 一、核心概念
1. **语境工程定义**：是在智能体运行轨迹的每一步，向其上下文窗口填充恰好合适信息的艺术与科学，类比操作系统筛选适合放入CPU的RAM（随机存取存储器）的内容，大语言模型（LLM）如CPU，上下文窗口如RAM，且窗口处理上下文来源的容量有限。
2. **需管理的上下文类型**：包含指令（提示词、记忆、少样本示例、工具描述等）、知识（事实、记忆等）、工具（来自工具调用的反馈）三类，语境工程是涵盖这些类型的总括性概念。
3. **智能体与语境工程的关联**：2025年，因LLM在推理和工具调用能力提升，人们对智能体兴趣大增。智能体常交织LLM调用与工具调用处理长期任务，但易因使用大量令牌引发超上下文窗口大小、成本/延迟飙升、性能下降等问题，还可能出现上下文污染、干扰、混淆、冲突等性能问题，故语境工程成为构建AI智能体工程师的首要工作，且智能体数百轮对话也需精心的语境管理策略。

## 二、四大语境工程策略
### （一）撰写上下文（Write Context）
- **定义**：将上下文保存在上下文窗口之外，助力智能体执行任务。
- **具体方式**
    - **暂存区（Scratchpads）**：类似人类做笔记，智能体执行任务时通过工具调用写入文件或利用运行时状态对象字段，将信息存储在上下文窗口外，方便后续获取，如Anthropic的多智能体研究工具会把计划保存到内存以防上下文窗口超20万令牌被截断。
    - **记忆（Memories）**：暂存区适用于单会话任务，记忆则能让智能体跨多会话复用信息。如Reflexion提出智能体每轮操作后反思并复用自主生成记忆，Generative Agents定期从过往反馈合成记忆，ChatGPT、Cursor、Windsurf等产品也基于用户 - 智能体交互自动生成长期记忆。

### （二）选择上下文（Select Context）
- **定义**：将相关上下文拉入上下文窗口，辅助智能体完成任务。
- **具体场景**
    - **暂存区选择**：依暂存区实现方式而定，工具类暂存区可通过工具调用读取，运行时状态类暂存区由开发者决定每步暴露给智能体的状态部分，实现对LLM暴露暂存区上下文的细粒度控制。
    - **记忆选择**：智能体需筛选与任务相关的记忆，如选少样本示例（情景记忆）、指令（程序记忆）、事实（语义记忆）。部分智能体固定使用一组文件，如代码智能体用文件存指令或示例，Claude Code用`CLAUDE.md`，Cursor和Windsurf用规则文件；存储大量语义记忆时选择难度大，如ChatGPT需从海量用户专属记忆中筛选，常用嵌入和知识图谱辅助，但仍有挑战，如曾出现ChatGPT意外提取用户位置插入图像的情况。
    - **工具选择**：工具过多易致智能体过载、模型选工具困惑，可将检索增强生成（RAG）应用于工具描述，依语义相似性选相关工具，近期论文显示此方法能将工具选择准确率提升3倍。
    - **知识选择**：RAG是核心语境工程挑战，代码智能体是其大规模应用典范。索引代码不等同于上下文检索，随代码库扩大，嵌入搜索可靠性下降，需结合grep/文件搜索、基于知识图谱的检索及上下文重排序等技术，如Windsurf采用AST解析代码并按语义边界分块等方式应对。

### （三）压缩上下文（Compressing Context）
- **定义**：仅保留执行任务所需的令牌，解决智能体交互中令牌过多问题。
- **具体方式**
    - **语境总结（Context Summarization）**：智能体交互跨数百轮且工具调用耗令牌，总结是常用应对方法。如Claude Code在上下文窗口使用率超95%时自动压缩，总结用户 - 智能体交互完整轨迹，还可在智能体设计特定环节加总结，如后处理耗令牌搜索工具、智能体间知识传递时减少令牌。但捕捉特定事件或决策时总结有难度，Cognition需用微调模型处理。
    - **语境修剪（Context Trimming）**：与总结用LLM提取相关内容不同，修剪多通过过滤或“裁剪”语境，如用硬编码启发式方法删除消息列表中较早消息，也有专用工具，如Drew Breunig提及的问答语境修剪器Provence。

### （四）隔离上下文（Isolating Context）
- **定义**：拆分上下文，为智能体执行任务创造更优条件。
- **具体方式**
    - **多智能体（Multi - agent）**：将上下文分配给子智能体，实现“关注点分离”，如OpenAI的Swarm库，各子智能体有专属工具集、指令和上下文窗口，可并行处理子任务。Anthropic的多智能体研究显示，多独立语境智能体表现优于单智能体，但存在令牌使用多（Anthropic称最多是聊天的15倍）、需精心设计提示词规划子任务、协调子智能体等挑战。
    - **用环境实现上下文隔离（Context Isolation with Environments）**：如HuggingFace的深度研究员采用的方式，多数智能体用工具调用API返回JSON对象获取反馈，而HuggingFace的CodeAgent输出含工具调用的代码，在沙箱中运行，仅将工具调用中选定上下文（如返回值）传回LLM，能有效隔离含大量令牌的对象，且便于状态处理，可将图像、音频等设为状态变量后续使用。
    - **状态（State）**：智能体的运行时状态对象可隔离上下文，类似沙箱功能。状态对象可设计带模式（如Pydantic模型），含可写入上下文的字段，仅将部分字段（如`messages`）在智能体每轮交互中暴露给LLM，其他字段信息隔离以按需使用。

## 三、总结
智能体语境工程模式仍在发展，当前常见方法可归为撰写、选择、压缩、隔离四类，理解并运用这些模式是当下构建高效智能体的核心环节。
