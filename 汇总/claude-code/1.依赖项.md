https://southbridge-research.notion.site/Dependencies-The-Foundation-of-Claude-Code-s-Architecture-2055fec70db181b3bb72cdfe615fad3c

<img width="2048" height="1274" alt="image" src="https://github.com/user-attachments/assets/b5e02448-370d-46e7-9c31-43cf7add7881" />

```
graph LR
    subgraph Input
        UserText[User Text]
        WebContent[Web Content]
        Images[Images]
        JSON[JSON Data]
    end

    subgraph Transform
        UserText --> Zod{Zod Validation}
        WebContent --> Marked[Markdown Parser]
        WebContent --> Turndown[HTMLâ†’MD]
        Images --> Sharp[Image Processor]
        JSON --> Zod
    end

    subgraph Output
        Zod --> ValidatedData[Type-Safe Data]
        Marked --> MarkdownAST[Markdown AST]
        Turndown --> MarkdownText[Markdown Text]
        Sharp --> OptimizedImage[Resized/Compressed]
    end

    ValidatedData --> LLM[To LLM]
    MarkdownAST --> LLM
    MarkdownText --> LLM
    OptimizedImage --> LLM
```
<img width="326" height="191" alt="image" src="https://github.com/user-attachments/assets/e542f417-dd31-4185-9c1e-ffe99c66bc90" />


# ä¾èµ–é¡¹ï¼šClaude Code æ¶æ„çš„åŸºçŸ³  

\* æ³¨ï¼šæ ‡æ³¨\*çš„å†…å®¹è¡¨ç¤ºåŸºäºåç¼–è¯‘åˆ†ææ¨æµ‹çš„è‡ªå®šä¹‰/åµŒå…¥å¼å®ç°  


## å®šä¹‰æ€§èƒ½çš„éå¸¸è§„é€‰æ‹©  

Claude Code çš„ä¾èµ–é¡¹æ¶æ„åŒ…å«å¤šé¡¹æå…·æ´å¯ŸåŠ›çš„å®ç°å†³ç­–ï¼Œè¿™äº›å†³ç­–ç›´æ¥é€ å°±äº†å…¶å‡ºè‰²çš„æ€§èƒ½ä¸å¯é æ€§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é¦–å…ˆæ·±å…¥æ¢ç´¢å…¶ä¸­æŠ€æœ¯å«é‡æœ€é«˜çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚  


### ğŸ” ç»ˆç«¯ä¸­çš„ React æ¶æ„  

```typescript
// æ ¸å¿ƒæ¸²æŸ“æµæ°´çº¿çš„å®ç°æ¨æµ‹å¦‚ä¸‹ï¼š
interface CliRenderPipeline {
  react: "^18.2.0",    // å®Œæ•´ React åè°ƒå™¨
  ink: "^3.2.0",       // ç»ˆç«¯æ¸²æŸ“å™¨
  yoga: "^2.0.0-beta.1"// Flexbox å¸ƒå±€å¼•æ“ï¼ˆåŸºäº WebAssemblyï¼‰
}

// æ ¸å¿ƒæ¸²æŸ“æµæ°´çº¿çš„å®ç°æ¨æµ‹å¦‚ä¸‹ï¼š
interface CliRenderPipeline {
  react: "^18.2.0",    // å®Œæ•´ React åè°ƒå™¨
  ink: "^3.2.0",       // ç»ˆç«¯æ¸²æŸ“å™¨
  yoga: "^2.0.0-beta.1"// Flexbox å¸ƒå±€å¼•æ“ï¼ˆåŸºäº WebAssemblyï¼‰
}
```  


#### ä¸ºä½•è¿™ä¸€è®¾è®¡è‡³å…³é‡è¦ï¼Ÿ  
ä¸ä¼ ç»Ÿå‘½ä»¤è¡Œå·¥å…·ï¼ˆCLIï¼‰é€šè¿‡å‘½ä»¤å¼æ–¹å¼ç®¡ç†çŠ¶æ€ä¸åŒï¼ŒClaude Code å€ŸåŠ© React çš„åè°ƒç®—æ³•å®ç°ç»ˆç«¯ç•Œé¢ï¼ˆUIï¼‰ç®¡ç†ã€‚è¿™ä¸€è®¾è®¡å¸¦æ¥ä¸‰å¤§æ ¸å¿ƒä¼˜åŠ¿ï¼š  
- **ç»ˆç«¯ä¸­çš„è™šæ‹Ÿ DOM**ï¼šæ¯æ¬¡ UI æ›´æ–°éƒ½ä¼šå…ˆç»è¿‡ React çš„å·®å¼‚å¯¹æ¯”ç®—æ³•ï¼Œå†ç”± yoga-layout è®¡ç®—ç»ˆç«¯å­—ç¬¦çš„æœ€ä¼˜ä½ç½®ï¼›  
- **å£°æ˜å¼ UI çŠ¶æ€**ï¼šå¤æ‚ UI çŠ¶æ€ï¼ˆå¦‚æƒé™å¯¹è¯æ¡†ã€è¿›åº¦æŒ‡ç¤ºå™¨ã€å·¥å…·å¹¶å‘æ‰§è¡Œç•Œé¢ï¼‰å‡é€šè¿‡å£°æ˜å¼æ–¹å¼ç®¡ç†ï¼›  
- **é«˜æ€§èƒ½**ï¼šåŸºäº WebAssembly çš„ yoga-layout æ¨¡å—ï¼Œå³ä¾¿é¢å¯¹å¤æ‚ UIï¼Œä¹Ÿèƒ½å®ç°äºšæ¯«ç§’çº§çš„å¸ƒå±€è®¡ç®—ã€‚  


â”Œâ”€ å®ç°æ´å¯Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ ä»ä¾èµ–é¡¹ `yoga-layout-prebuilt` å¯æ¨æµ‹ï¼ŒClaude Code â”‚  
â”‚ ä¼šé¢„ç¼–è¯‘å¸ƒå±€çº¦æŸï¼Œä»¥å†…å­˜å ç”¨ä¸ºä»£ä»·ï¼Œæ¢å–å¿«é€Ÿ UI æ›´æ–°æ—¶ â”‚  
â”‚ï¼ˆå¦‚ LLM æµå¼å“åº”ï¼‰çš„é€Ÿåº¦æå‡                          â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  


### ğŸ” æµå¼è§£æå™¨æ¶æ„  

åŸºäºåç¼–è¯‘åˆ†æï¼ŒClaude Code ä¼¼ä¹åµŒå…¥äº†å…³é”®è§£æå™¨çš„è‡ªå®šä¹‰å®ç°ï¼š  

```typescript
// ä»ä¾èµ–é¡¹åˆ†ææ¨æµ‹çš„è§£æå™¨èƒ½åŠ›
const CUSTOM_PARSERS = {
  'shell-parse': {
    features: [
      'é€šè¿‡æ ‡è®°å­—ç¬¦ä¸²åµŒå…¥ JSON å¯¹è±¡',
      'é€’å½’å‘½ä»¤æ›¿æ¢',
      'ä¿ç•™ç±»å‹çš„ç¯å¢ƒå˜é‡å±•å¼€'
    ],
    performance: 'å•éåˆ†è¯ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)'
  },
  'fast-xml-parser': {
    features: [
      'å·¥å…·è°ƒç”¨çš„æµå¼ XML è§£æ',
      'éƒ¨åˆ†æ–‡æ¡£æ¢å¤åŠŸèƒ½',
      'é’ˆå¯¹ LLM è¾“å‡ºçš„è‡ªå®šä¹‰å®ä½“å¤„ç†'
    ],
    performance: 'å†…å­˜å ç”¨ä¸æ–‡æ¡£å¤§å°æ— å…³ï¼Œå§‹ç»ˆä¿æŒæ’å®š'
  }
}

// ä»ä¾èµ–é¡¹åˆ†ææ¨æµ‹çš„è§£æå™¨èƒ½åŠ›
const CUSTOM_PARSERS = {
  'shell-parse': {
    features: [
      'é€šè¿‡æ ‡è®°å­—ç¬¦ä¸²åµŒå…¥ JSON å¯¹è±¡',
      'é€’å½’å‘½ä»¤æ›¿æ¢',
      'ä¿ç•™ç±»å‹çš„ç¯å¢ƒå˜é‡å±•å¼€'
    ],
    performance: 'å•éåˆ†è¯ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)'
  },
  'fast-xml-parser': {
    features: [
      'å·¥å…·è°ƒç”¨çš„æµå¼ XML è§£æ',
      'éƒ¨åˆ†æ–‡æ¡£æ¢å¤åŠŸèƒ½',
      'é’ˆå¯¹ LLM è¾“å‡ºçš„è‡ªå®šä¹‰å®ä½“å¤„ç†'
    ],
    performance: 'å†…å­˜å ç”¨ä¸æ–‡æ¡£å¤§å°æ— å…³ï¼Œå§‹ç»ˆä¿æŒæ’å®š'
  }
}
```  


#### Shell è§£æå™¨çš„æ ¸å¿ƒä¼˜åŠ¿  
```javascript
// åŸºäºåˆ†ææ¨æµ‹çš„æ¦‚å¿µæ€§å®ç°
function parseShellWithObjects(cmd, env) {
  const SENTINEL = crypto.randomBytes(16).toString('hex');
  
  // é˜¶æ®µ 1ï¼šå¯¹è±¡åºåˆ—åŒ–
  const processedEnv = Object.entries(env).reduce((acc, [key, val]) => {
    if (typeof val === 'object') {
      acc[key] = SENTINEL + JSON.stringify(val) + SENTINEL;
    } else {
      acc[key] = val;
    }
    return acc;
  }, {});
  
  // é˜¶æ®µ 2ï¼šä¿ç•™æ ‡è®°çš„æ ‡å‡† Shell è§£æ
  const tokens = shellParse(cmd, processedEnv);
  
  // é˜¶æ®µ 3ï¼šå¯¹è±¡è¿˜åŸ
  return tokens.map(token => {
    if (token.match(new RegExp(`^${SENTINEL}.*${SENTINEL}$`))) {
      return JSON.parse(token.slice(SENTINEL.length, -SENTINEL.length));
    }
    return token;
  });
}

// åŸºäºåˆ†ææ¨æµ‹çš„æ¦‚å¿µæ€§å®ç°
function parseShellWithObjects(cmd, env) {
  const SENTINEL = crypto.randomBytes(16).toString('hex');
  
  // é˜¶æ®µ 1ï¼šå¯¹è±¡åºåˆ—åŒ–
  const processedEnv = Object.entries(env).reduce((acc, [key, val]) => {
    if (typeof val === 'object') {
      acc[key] = SENTINEL + JSON.stringify(val) + SENTINEL;
    } else {
      acc[key] = val;
    }
    return acc;
  }, {});
  
  // é˜¶æ®µ 2ï¼šä¿ç•™æ ‡è®°çš„æ ‡å‡† Shell è§£æ
  const tokens = shellParse(cmd, processedEnv);
  
  // é˜¶æ®µ 3ï¼šå¯¹è±¡è¿˜åŸ
  return tokens.map(token => {
    if (token.match(new RegExp(`^${SENTINEL}.*${SENTINEL}$`))) {
      return JSON.parse(token.slice(SENTINEL.length, -SENTINEL.length));
    }
    return token;
  });
}
```  

è¿™ä¸€è®¾è®¡ä½¿ Claude Code èƒ½å¤Ÿé€šè¿‡ Shell å‘½ä»¤ä¼ é€’å¤æ‚é…ç½®å¯¹è±¡â€”â€”è¿™æ˜¯æ ‡å‡† Shell è§£æå™¨ä¸å…·å¤‡çš„èƒ½åŠ›ã€‚  


### ğŸ” è·¨å¹³å° LLM æŠ½è±¡å±‚  

ä¾èµ–é¡¹ç»“æ„æ­ç¤ºäº†ä¸€å¥—å¤æ‚çš„å¤šå‚å•†é›†æˆæ–¹æ¡ˆï¼š  

| å¹³å°ï¼ˆPlatformï¼‰ | ä¸» SDKï¼ˆPrimary SDKï¼‰               | æµå¼æ”¯æŒï¼ˆStreamingï¼‰ | ç‰¹è‰²åŠŸèƒ½ï¼ˆSpecialized Featuresï¼‰               |
|------------------|-------------------------------------|------------------------|-----------------------------------------------|
| Anthropic        | Native SDKï¼ˆåŸç”Ÿ SDKï¼‰              | âœ“ å®Œæ•´ SSE æ”¯æŒ        | æ€è€ƒå—ï¼ˆThinking blocksï¼‰ã€ç¼“å­˜æ§åˆ¶            |
| AWS Bedrock      | @aws-sdk/client-bedrock-runtime     | âœ“ è‡ªå®šä¹‰é€‚é…å™¨         | è·¨åŒºåŸŸæ•…éšœè½¬ç§»ã€SigV4 è®¤è¯                    |
| Google Vertex    | google-auth-library + è‡ªå®šä¹‰æ‰©å±•    | âœ“ é€šè¿‡é€‚é…å™¨æ”¯æŒ       | è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°                                  |  


#### å®ç°æ¨¡å¼  
```typescript
// ä»ä¾èµ–é¡¹æ¨æµ‹çš„å·¥å‚æ¨¡å¼
class LLMClientFactory {
  static create(provider: string): StreamingLLMClient {
    switch (provider) {
      case 'anthropic':
        return new AnthropicStreamAdapter();
      case 'bedrock':
        return new BedrockStreamAdapter(
          new BedrockRuntimeClient(), 
          new SigV4Signer()
        );
      case 'vertex':
        return new VertexStreamAdapter(
          new GoogleAuth(), 
          new CustomHTTPClient()
        );
    }
  }
}

// ä»ä¾èµ–é¡¹æ¨æµ‹çš„å·¥å‚æ¨¡å¼
class LLMClientFactory {
  static create(provider: string): StreamingLLMClient {
    switch (provider) {
      case 'anthropic':
        return new AnthropicStreamAdapter();
      case 'bedrock':
        return new BedrockStreamAdapter(
          new BedrockRuntimeClient(), 
          new SigV4Signer()
        );
      case 'vertex':
        return new VertexStreamAdapter(
          new GoogleAuth(), 
          new CustomHTTPClient()
        );
    }
  }
}
```  


### ğŸ” é¥æµ‹ä¸‰é‡æ ˆ  

Claude Code é‡‡ç”¨ä¸‰å¥—äº’è¡¥ç³»ç»Ÿï¼Œæ„å»ºäº†å…¨é¢çš„å¯è§‚æµ‹æ€§ç­–ç•¥ï¼š  

```
â”Œâ”€ é”™è¯¯è·Ÿè¸ªï¼ˆError Trackingï¼‰ â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ æŒ‡æ ‡ç›‘æ§ï¼ˆMetricsï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ åŠŸèƒ½æ ‡å¿—ï¼ˆFeature Flagsï¼‰ â”€â”€â”€â”
â”‚ @sentry/node                       â”‚  â”‚ @opentelemetry/api              â”‚  â”‚ statsig-node                  â”‚
â”‚ â”œâ”€ ANRï¼ˆåº”ç”¨æ— å“åº”ï¼‰æ£€æµ‹           â”‚  â”‚ â”œâ”€ è‡ªå®šä¹‰è¿½è¸ªè·¨åº¦ï¼ˆCustom spansï¼‰â”‚  â”‚ â”œâ”€ A/B æµ‹è¯•                   â”‚
â”‚ â”œâ”€ é”™è¯¯è¾¹ç•Œï¼ˆError boundariesï¼‰    â”‚  â”‚ â”œâ”€ Token è®¡æ•°å™¨                 â”‚  â”‚ â”œâ”€ æ¸è¿›å¼å‘å¸ƒï¼ˆGradual rolloutï¼‰â”‚
â”‚ â””â”€ æ€§èƒ½åˆ†æ                       â”‚  â”‚ â””â”€ å»¶è¿Ÿç›´æ–¹å›¾                   â”‚  â”‚ â””â”€ åŠ¨æ€é…ç½®                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                      â†“                          â†“
        è°ƒè¯•ï¼ˆDebuggingï¼‰                    ä¼˜åŒ–ï¼ˆOptimizationï¼‰              å®éªŒï¼ˆExperimentationï¼‰
```  

```
â”Œâ”€ é”™è¯¯è·Ÿè¸ªï¼ˆError Trackingï¼‰ â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ æŒ‡æ ‡ç›‘æ§ï¼ˆMetricsï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ åŠŸèƒ½æ ‡å¿—ï¼ˆFeature Flagsï¼‰ â”€â”€â”€â”
â”‚ @sentry/node                       â”‚  â”‚ @opentelemetry/api              â”‚  â”‚ statsig-node                  â”‚
â”‚ â”œâ”€ ANRï¼ˆåº”ç”¨æ— å“åº”ï¼‰æ£€æµ‹           â”‚  â”‚ â”œâ”€ è‡ªå®šä¹‰è¿½è¸ªè·¨åº¦ï¼ˆCustom spansï¼‰â”‚  â”‚ â”œâ”€ A/B æµ‹è¯•                   â”‚
â”‚ â”œâ”€ é”™è¯¯è¾¹ç•Œï¼ˆError boundariesï¼‰    â”‚  â”‚ â”œâ”€ Token è®¡æ•°å™¨                 â”‚  â”‚ â”œâ”€ æ¸è¿›å¼å‘å¸ƒï¼ˆGradual rolloutï¼‰â”‚
â”‚ â””â”€ æ€§èƒ½åˆ†æ                       â”‚  â”‚ â””â”€ å»¶è¿Ÿç›´æ–¹å›¾                   â”‚  â”‚ â””â”€ åŠ¨æ€é…ç½®                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                      â†“                          â†“
        è°ƒè¯•ï¼ˆDebuggingï¼‰                    ä¼˜åŒ–ï¼ˆOptimizationï¼‰              å®éªŒï¼ˆExperimentationï¼‰
```  


#### ANR æ£€æµ‹çš„åˆ›æ–°è®¾è®¡ï¼ˆä» Sentry é›†æˆæ¨¡å¼æ¨æµ‹ï¼‰  
```typescript
// é€‚ç”¨äº Node.js çš„åº”ç”¨æ— å“åº”ï¼ˆANRï¼‰æ£€æµ‹
class ANRDetector {
  private worker: Worker;
  private heartbeatInterval = 50; // å•ä½ï¼šæ¯«ç§’

  constructor() {
    // å¯åŠ¨å·¥ä½œçº¿ç¨‹ï¼Œç›‘å¬ä¸»çº¿ç¨‹å¿ƒè·³
    this.worker = new Worker(`
      let lastPing = Date.now();
      setInterval(() => {
        if (Date.now() - lastPing > 5000) {
          parentPort.postMessage({
            type: 'anr',
            stack: getMainThreadStack() // é€šè¿‡æ£€æŸ¥å™¨åè®®è·å–ä¸»çº¿ç¨‹è°ƒç”¨æ ˆ
          });
        }
      }, 100);
    `, { eval: true });

    // ä¸»çº¿ç¨‹å®šæœŸå‘é€å¿ƒè·³
    setInterval(() => {
      this.worker.postMessage({ type: 'ping' });
    }, this.heartbeatInterval);
  }
}

// é€‚ç”¨äº Node.js çš„åº”ç”¨æ— å“åº”ï¼ˆANRï¼‰æ£€æµ‹
class ANRDetector {
  private worker: Worker;
  private heartbeatInterval = 50; // å•ä½ï¼šæ¯«ç§’

  constructor() {
    // å¯åŠ¨å·¥ä½œçº¿ç¨‹ï¼Œç›‘å¬ä¸»çº¿ç¨‹å¿ƒè·³
    this.worker = new Worker(`
      let lastPing = Date.now();
      setInterval(() => {
        if (Date.now() - lastPing > 5000) {
          parentPort.postMessage({
            type: 'anr',
            stack: getMainThreadStack() // é€šè¿‡æ£€æŸ¥å™¨åè®®è·å–ä¸»çº¿ç¨‹è°ƒç”¨æ ˆ
          });
        }
      }, 100);
    `, { eval: true });

    // ä¸»çº¿ç¨‹å®šæœŸå‘é€å¿ƒè·³
    setInterval(() => {
      this.worker.postMessage({ type: 'ping' });
    }, this.heartbeatInterval);
  }
}
```  

è¿™ä¸€è®¾è®¡ä½¿ Claude Code èƒ½å¤Ÿæ£€æµ‹å¹¶ä¸ŠæŠ¥ä¸»çº¿ç¨‹äº‹ä»¶å¾ªç¯é˜»å¡çš„æƒ…å†µâ€”â€”è¿™å¯¹æ’æŸ¥ç”Ÿäº§ç¯å¢ƒä¸­çš„æ€§èƒ½é—®é¢˜è‡³å…³é‡è¦ã€‚  


### ğŸ” æ•°æ®è½¬æ¢æµæ°´çº¿  

æ•°æ®å¤„ç†ä¾èµ–é¡¹æ„æˆäº†ä¸€å¥—å¤æ‚çš„æµæ°´çº¿ï¼Œæµç¨‹å¦‚ä¸‹ï¼š  

```mermaid
graph LR
    A[è¾“å…¥ï¼ˆInputï¼‰] -->|ç”¨æˆ·æ–‡æœ¬| B[Markdown æ–‡æœ¬]
    A -->|ç½‘é¡µå†…å®¹| C[HTMLâ†’MD è½¬æ¢]
    A -->|å›¾ç‰‡| D[å›¾ç‰‡å¤„ç†å™¨ï¼ˆImage Processorï¼‰]
    A -->|JSON æ•°æ®| E[Zod éªŒè¯]
    B --> F[Markdown AST]
    C --> F
    D --> G[å‹ç¼©/è°ƒæ•´å¤§å°ï¼ˆResized/Compressedï¼‰]
    E --> H[ç±»å‹å®‰å…¨æ•°æ®ï¼ˆType-Safe Dataï¼‰]
    F --> H
    G --> H
    H --> I[è¾“å‡ºè‡³ LLMï¼ˆTo LLMï¼‰]
```  


#### Sharp é…ç½®ï¼ˆä»å¸¸è§æ¨¡å¼æ¨æµ‹ï¼‰  
```javascript
const imageProcessor = sharp(inputBuffer)
  .resize(1024, 1024, {
    fit: 'inside',       // ç¡®ä¿å›¾ç‰‡å®Œå…¨åŒ…å«åœ¨å°ºå¯¸å†…
    withoutEnlargement: true // ä¸æ”¾å¤§å°äºç›®æ ‡å°ºå¯¸çš„å›¾ç‰‡
  })
  .jpeg({
    quality: 85,         // å›¾ç‰‡è´¨é‡
    progressive: true    // æ¸è¿›å¼åŠ è½½ï¼ˆæ›´é€‚åˆæµå¼åœºæ™¯ï¼‰
  });

const imageProcessor = sharp(inputBuffer)
  .resize(1024, 1024, {
    fit: 'inside',       // ç¡®ä¿å›¾ç‰‡å®Œå…¨åŒ…å«åœ¨å°ºå¯¸å†…
    withoutEnlargement: true // ä¸æ”¾å¤§å°äºç›®æ ‡å°ºå¯¸çš„å›¾ç‰‡
  })
  .jpeg({
    quality: 85,         // å›¾ç‰‡è´¨é‡
    progressive: true    // æ¸è¿›å¼åŠ è½½ï¼ˆæ›´é€‚åˆæµå¼åœºæ™¯ï¼‰
  });
```  


### ğŸ” MCP ä¼ è¾“å±‚  

â€œå¤šäº‘/å¤šè¿›ç¨‹â€ï¼ˆMulti-Cloud/Processï¼ŒMCPï¼‰æ¶æ„é‡‡ç”¨äº†ä¸€å¥—æå…·å·§æ€çš„æŠ½è±¡è®¾è®¡ï¼š  

```typescript
// ä¼ è¾“å±‚æŠ½è±¡æ¨¡å¼
interface MCPTransport {
  stdio: 'cross-spawn',  // æœ¬åœ°è¿›ç¨‹é€šä¿¡
  websocket: 'ws',       // å®æ—¶åŒå‘é€šä¿¡
  sse: 'eventsource'     // æœåŠ¡ç«¯æ¨é€äº‹ä»¶ï¼ˆServer-sent eventsï¼‰
}

// èƒ½åŠ›åå•†æµç¨‹æ¨æµ‹
class MCPClient {
  async initialize() {
    const capabilities = await this.transport.request('initialize', {
      capabilities: {
        tools: true,
        resources: true,
        prompts: true,
        logging: { level: 'info' }
      }
    });
    
    // åŠ¨æ€ç‰¹æ€§æ£€æµ‹
    this.features = this.negotiateFeatures(capabilities);
  }
}

// ä¼ è¾“å±‚æŠ½è±¡æ¨¡å¼
interface MCPTransport {
  stdio: 'cross-spawn',  // æœ¬åœ°è¿›ç¨‹é€šä¿¡
  websocket: 'ws',       // å®æ—¶åŒå‘é€šä¿¡
  sse: 'eventsource'     // æœåŠ¡ç«¯æ¨é€äº‹ä»¶ï¼ˆServer-sent eventsï¼‰
}

// èƒ½åŠ›åå•†æµç¨‹æ¨æµ‹
class MCPClient {
  async initialize() {
    const capabilities = await this.transport.request('initialize', {
      capabilities: {
        tools: true,
        resources: true,
        prompts: true,
        logging: { level: 'info' }
      }
    });
    
    // åŠ¨æ€ç‰¹æ€§æ£€æµ‹
    this.features = this.negotiateFeatures(capabilities);
  }
}
```  


## ä¾èµ–é¡¹åˆ†ç±»æ·±åº¦è§£æ  


### æ ¸å¿ƒ CLI æ¡†æ¶ï¼ˆ15+ ä¸ªåŒ…ï¼‰  

CLI æ¡†æ¶ä¾èµ–é¡¹å±•ç°äº†ä¸€å¥—å¤æ‚çš„ç»ˆç«¯ UI å®ç°æ–¹æ¡ˆï¼š  

| åŒ…ï¼ˆPackageï¼‰         | ç‰ˆæœ¬*ï¼ˆVersion*ï¼‰ | ç”¨é€”ï¼ˆPurposeï¼‰               | æŠ€æœ¯æ´å¯Ÿï¼ˆTechnical Insightï¼‰               |
|-----------------------|-------------------|-------------------------------|---------------------------------------------|
| ink                   | ^3.2.0            | React ç»ˆç«¯æ¸²æŸ“å™¨              | è‡ªå®šä¹‰åè°ƒå™¨å®ç°                            |
| react                 | ^18.2.0           | UI ç»„ä»¶æ¨¡å‹                   | å¯ç”¨å®Œæ•´å¹¶å‘ç‰¹æ€§                            |
| yoga-layout-prebuilt  | ^1.10.0           | Flexbox å¸ƒå±€                  | åŸºäº WebAssembly æå‡æ€§èƒ½                   |
| commander             | ^9.0.0            | å‘½ä»¤è¡Œå‚æ•°è§£æ                | æ‰©å±•äº†è‡ªå®šä¹‰é€‰é¡¹ç±»å‹                        |
| chalk                 | ^4.1.2            | ç»ˆç«¯æ ·å¼ç¾åŒ–                  | é‡‡ç”¨æ¨¡æ¿å­—ç¬¦ä¸² API                          |
| cli-highlight         | ^2.1.11           | è¯­æ³•é«˜äº®                      | æ–°å¢è‡ªå®šä¹‰è¯­è¨€å®šä¹‰                          |
| strip-ansi            | ^6.0.1            | ANSI ä»£ç ç§»é™¤                  | ç”¨äºæ–‡æœ¬å®½åº¦æµ‹é‡                            |
| string-width          | ^4.2.3            | Unicode å­—ç¬¦å®½åº¦è®¡ç®—           | å®Œæ•´æ”¯æŒè¡¨æƒ…ç¬¦å·ï¼ˆemojiï¼‰                   |
| wrap-ansi             | ^7.0.0            | æ–‡æœ¬æ¢è¡Œ                      | ä¿ç•™ ANSI æ ·å¼                              |
| cli-spinners          | ^2.7.0            | åŠ è½½åŠ¨ç”»                      | è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»å®šä¹‰                          |

\* ç‰ˆæœ¬å·åŸºäºç”Ÿæ€å…¼å®¹æ€§åˆ†ææ¨æµ‹  


#### æ€§èƒ½ä¼˜åŒ–æ¨¡å¼  
```javascript
// å¸¦ç¼“å­˜çš„å­—ç¬¦ä¸²å®½åº¦è®¡ç®—
const widthCache = new Map();

function getCachedWidth(str) {
  if (!widthCache.has(str)) {
    widthCache.set(str, stringWidth(str));
  }
  return widthCache.get(str);
}

// å¸¦ç¼“å­˜çš„å­—ç¬¦ä¸²å®½åº¦è®¡ç®—
const widthCache = new Map();

function getCachedWidth(str) {
  if (!widthCache.has(str)) {
    widthCache.set(str, stringWidth(str));
  }
  return widthCache.get(str);
}
```  


<img width="342" height="407" alt="image" src="https://github.com/user-attachments/assets/f6654bd0-b607-4ad0-8042-a4f8506c0c12" />

### LLM é›†æˆæ ˆï¼ˆ5+ ä¸ªåŒ…ï¼‰
LLM é›†æˆéƒ¨åˆ†é‡‡ç”¨äº†å¤šä¾›åº”å•†ç­–ç•¥ï¼Œå¹¶è®¾è®¡äº†å®Œå–„çš„é™çº§æœºåˆ¶ï¼š

```
â”Œâ”€ ä¾›åº”å•†é€‰æ‹©é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ API å¯†é’¥å¯ç”¨æ€§                          â”‚
â”‚ 2. è¯„ä¼°å„ä¾›åº”å•†çš„è°ƒç”¨é¢‘ç‡é™åˆ¶                   â”‚
â”‚ 3. è€ƒè™‘åŠŸèƒ½éœ€æ±‚ï¼ˆæµå¼ä¼ è¾“ã€å·¥å…·è°ƒç”¨æ”¯æŒï¼‰        â”‚
â”‚ 4. åº”ç”¨æˆæœ¬ä¼˜åŒ–è§„åˆ™                             â”‚
â”‚ 5. é™çº§é“¾ï¼šAnthropic â†’ Bedrock â†’ Vertex        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

AWS SDK ç»„ä»¶ï¼ˆåŸºäº `@aws-sdk/*` ç›¸å…³æ¨¡å¼æ¨æµ‹ï¼‰ï¼š
- `@aws-sdk/client-bedrock-runtime`ï¼šBedrock æ ¸å¿ƒå®¢æˆ·ç«¯
- `@aws-sdk/signature-v4`ï¼šè¯·æ±‚ç­¾åå·¥å…·
- `@aws-sdk/middleware-retry`ï¼šæ™ºèƒ½é‡è¯•é€»è¾‘
- `@aws-sdk/smithy-client`ï¼šåè®®å®ç°åŸºç¡€
- `@aws-sdk/types`ï¼šå…±äº«ç±»å‹å®šä¹‰


### æ•°æ®å¤„ç†ä¸éªŒè¯ï¼ˆ8+ ä¸ªåŒ…ï¼‰
```typescript
// åŸºäºæ¨æµ‹çš„ Zod æ¨¡å¼ç¼–è¯‘é€»è¾‘
const COMPILED_SCHEMAS = new Map();

function getCompiledSchema(schema: ZodSchema) {
  const key = schema._def.shape; // ç®€åŒ–å¤„ç†
  if (!COMPILED_SCHEMAS.has(key)) {
    COMPILED_SCHEMAS.set(key, {
      validator: schema.parse.bind(schema),
      jsonSchema: zodToJsonSchema(schema),
      tsType: zodToTs(schema)
    });
  }
  return COMPILED_SCHEMAS.get(key);
}

// åŸºäºæ¨æµ‹çš„ Zod æ¨¡å¼ç¼–è¯‘é€»è¾‘
const COMPILED_SCHEMAS = new Map();

function getCompiledSchema(schema: ZodSchema) {
  const key = schema._def.shape; // ç®€åŒ–å¤„ç†
  if (!COMPILED_SCHEMAS.has(key)) {
    COMPILED_SCHEMAS.set(key, {
      validator: schema.parse.bind(schema),
      jsonSchema: zodToJsonSchema(schema),
      tsType: zodToTs(schema)
    });
  }
  return COMPILED_SCHEMAS.get(key);
}
```

#### è½¬æ¢æµæ°´çº¿æ€§èƒ½å¯¹æ¯”
| æ“ä½œï¼ˆOperationï¼‰       | ä¾èµ–åº“ï¼ˆLibraryï¼‰ | æ€§èƒ½ï¼ˆPerformanceï¼‰ | å†…å­˜ç‰¹æ€§ï¼ˆMemoryï¼‰               |
|-------------------------|-------------------|---------------------|----------------------------------|
| Markdownâ†’æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ | marked            | O(n)                | æ”¯æŒæµå¼å¤„ç†                     |
| HTMLâ†’Markdown           | turndown          | O(n)                | é™åˆ¶ DOM å¤§å°é˜²æ­¢å†…å­˜æº¢å‡º        |
| å›¾ç‰‡ç¼©æ”¾                | sharp             | O(1)*               | ä½¿ç”¨åŸç”Ÿå†…å­˜ï¼ˆé JS å †å†…å­˜ï¼‰     |
| JSON éªŒè¯               | zod               | O(n)                | å¿«é€Ÿå¤±è´¥ï¼ˆFail-fastï¼‰æœºåˆ¶        |
| æ–‡æœ¬å·®å¼‚å¯¹æ¯”            | diff              | O(nÂ²)               | é‡‡ç”¨ Myers ç®—æ³•                  |

\* æ³¨ï¼šå¸¦ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ


### æ–‡ä»¶ç³»ç»Ÿæ™ºèƒ½å¤„ç†ï¼ˆ6+ ä¸ªåŒ…ï¼‰
æ–‡ä»¶ç³»ç»Ÿç›¸å…³ä¾èµ–é¡¹å®ç°äº†ä¸€å¥—å¤æ‚çš„è¿‡æ»¤æµæ°´çº¿ï¼š

```mermaid
graph LR
    A[ç”¨æˆ·æ¨¡å¼ï¼ˆUser Patternï¼‰] --> B[glob]
    A --> C[picomatch]
    A --> D[minimatch]
    B --> E[æ–‡ä»¶åˆ—è¡¨ï¼ˆFile Listï¼‰]
    C --> E
    D --> E
    F[.gitignore è§„åˆ™] --> G[ignore]
    H[è‡ªå®šä¹‰è§„åˆ™ï¼ˆCustom Rulesï¼‰] --> G
    E --> G
    G --> I[è¿‡æ»¤ç»“æœï¼ˆFiltered Resultsï¼‰]
```

#### æ¨¡å¼åŒ¹é…ä¼˜åŒ–
```javascript
// åŸºäºæ¨æµ‹çš„ç¼–è¯‘æ¨¡å¼ç¼“å­˜é€»è¾‘
class PatternMatcher {
  private compiledPatterns = new LRUCache(1000); // ç¼“å­˜ä¸Šé™ 1000 æ¡

  match(pattern, path) {
    let compiled = this.compiledPatterns.get(pattern);
    if (!compiled) {
      compiled = picomatch(pattern, {
        bash: true,    // æ”¯æŒ Bash é£æ ¼æ¨¡å¼
        dot: true,     // åŒ¹é…éšè—æ–‡ä»¶ï¼ˆä»¥ . å¼€å¤´ï¼‰
        nobrace: false // å¯ç”¨å¤§æ‹¬å·æ‰©å±•
      });
      this.compiledPatterns.set(pattern, compiled);
    }
    return compiled(path);
  }
}

// åŸºäºæ¨æµ‹çš„ç¼–è¯‘æ¨¡å¼ç¼“å­˜é€»è¾‘
class PatternMatcher {
  private compiledPatterns = new LRUCache(1000); // ç¼“å­˜ä¸Šé™ 1000 æ¡

  match(pattern, path) {
    let compiled = this.compiledPatterns.get(pattern);
    if (!compiled) {
      compiled = picomatch(pattern, {
        bash: true,    // æ”¯æŒ Bash é£æ ¼æ¨¡å¼
        dot: true,     // åŒ¹é…éšè—æ–‡ä»¶ï¼ˆä»¥ . å¼€å¤´ï¼‰
        nobrace: false // å¯ç”¨å¤§æ‹¬å·æ‰©å±•
      });
      this.compiledPatterns.set(pattern, compiled);
    }
    return compiled(path);
  }
}
```


### é¥æµ‹ä¸å¯è§‚æµ‹æ€§ï¼ˆ4+ ä¸ªåŒ…ï¼‰
é¥æµ‹æ ˆé‡‡ç”¨äº†â€œçºµæ·±é˜²å¾¡â€çš„ç›‘æ§ç­–ç•¥ï¼š

#### Sentry é›†æˆå±‚çº§
1. **é”™è¯¯è¾¹ç•Œï¼ˆError Boundaryï¼‰**ï¼šæ•è· React UI å´©æºƒ
2. **å…¨å±€å¤„ç†å™¨**ï¼šç›‘å¬è¿›ç¨‹çº§æœªæ•è·å¼‚å¸¸
3. **Promise æ‹’ç»è·Ÿè¸ª**ï¼šå¤„ç†æœªæ•è·çš„ Promise é”™è¯¯
4. **ANR æ£€æµ‹**ï¼šé€šè¿‡è‡ªå®šä¹‰å·¥ä½œçº¿ç¨‹ç›‘æ§ä¸»çº¿ç¨‹é˜»å¡
5. **æ€§èƒ½è·Ÿè¸ª**ï¼šè®°å½•äº‹åŠ¡ä¸è¿½è¸ªè·¨åº¦ï¼ˆSpanï¼‰

#### OpenTelemetry åŸ‹ç‚¹
```typescript
// å·¥å…·æ‰§è¡Œçš„è‡ªå®šä¹‰è¿½è¸ªè·¨åº¦åˆ›å»ºé€»è¾‘
function instrumentToolExecution(tool: Tool) {
  return async function* (...args) {
    // åˆ›å»ºå·¥å…·æ‰§è¡Œç›¸å…³çš„è¿½è¸ªè·¨åº¦
    const span = tracer.startSpan(`tool.${tool.name}`, {
      attributes: {
        'tool.name': tool.name,
        'tool.readonly': tool.isReadOnly,
        'tool.input.size': JSON.stringify(args[0]).length // è¾“å…¥æ•°æ®å¤§å°
      }
    });

    try {
      yield* tool.call(...args); // æ‰§è¡Œå·¥å…·å¹¶ä¼ é€’ç”Ÿæˆå™¨
    } finally {
      span.end(); // ç¡®ä¿è¿½è¸ªè·¨åº¦æœ€ç»ˆå…³é—­
    }
  };
}

// å·¥å…·æ‰§è¡Œçš„è‡ªå®šä¹‰è¿½è¸ªè·¨åº¦åˆ›å»ºé€»è¾‘
function instrumentToolExecution(tool: Tool) {
  return async function* (...args) {
    // åˆ›å»ºå·¥å…·æ‰§è¡Œç›¸å…³çš„è¿½è¸ªè·¨åº¦
    const span = tracer.startSpan(`tool.${tool.name}`, {
      attributes: {
        'tool.name': tool.name,
        'tool.readonly': tool.isReadOnly,
        'tool.input.size': JSON.stringify(args[0]).length // è¾“å…¥æ•°æ®å¤§å°
      }
    });

    try {
      yield* tool.call(...args); // æ‰§è¡Œå·¥å…·å¹¶ä¼ é€’ç”Ÿæˆå™¨
    } finally {
      span.end(); // ç¡®ä¿è¿½è¸ªè·¨åº¦æœ€ç»ˆå…³é—­
    }
  };
}
```

#### Statsig åŠŸèƒ½æ ‡å¿—æ¨¡å¼
```javascript
// åŸºäºæ¨æµ‹çš„æ¸è¿›å¼å‘å¸ƒé…ç½®
const FEATURE_FLAGS = {
  'unified_read_tool': {
    rollout: 0.5, // 50% ç”¨æˆ·å¯è§
    overrides: { internal: 1.0 } // å†…éƒ¨ç”¨æˆ· 100% å¯è§
  },
  'parallel_tool_execution': {
    rollout: 1.0, // å…¨é‡å‘å¸ƒ
    conditions: [
      {
        type: 'user_tier',
        operator: 'in',
        values: ['pro', 'enterprise'] // ä»… Pro/ä¼ä¸šç‰ˆç”¨æˆ·å¯ç”¨
      }
    ]
  },
  'sandbox_bash_default': {
    rollout: 0.1, // 10% ç”¨æˆ·ç°åº¦
    sticky: true // ç”¨æˆ·ä¸€æ—¦å‘½ä¸­ï¼Œåç»­ä¿æŒä¸€è‡´ï¼ˆç²˜æ€§é…ç½®ï¼‰
  }
};

// åŸºäºæ¨æµ‹çš„æ¸è¿›å¼å‘å¸ƒé…ç½®
const FEATURE_FLAGS = {
  'unified_read_tool': {
    rollout: 0.5, // 50% ç”¨æˆ·å¯è§
    overrides: { internal: 1.0 } // å†…éƒ¨ç”¨æˆ· 100% å¯è§
  },
  'parallel_tool_execution': {
    rollout: 1.0, // å…¨é‡å‘å¸ƒ
    conditions: [
      {
        type: 'user_tier',
        operator: 'in',
        values: ['pro', 'enterprise'] // ä»… Pro/ä¼ä¸šç‰ˆç”¨æˆ·å¯ç”¨
      }
    ]
  },
  'sandbox_bash_default': {
    rollout: 0.1, // 10% ç”¨æˆ·ç°åº¦
    sticky: true // ç”¨æˆ·ä¸€æ—¦å‘½ä¸­ï¼Œåç»­ä¿æŒä¸€è‡´ï¼ˆç²˜æ€§é…ç½®ï¼‰
  }
};
```


## éšè—äº®ç‚¹ï¼šä¸“ç”¨ä¾èµ–é¡¹è§£æ


### ç”¨äº LLM é€šä¿¡çš„ XML è§£æ
åµŒå…¥å¼çš„ `fast-xml-parser` ä¼¼ä¹ç»è¿‡å®šåˆ¶ï¼Œä¸“é—¨é€‚é… LLM å“åº”è§£æï¼š
```javascript
// åŸºäºæ¨æµ‹çš„ XML è§£æå™¨é…ç½®
const llmXmlParser = new XMLParser({
  ignoreAttributes: true,    // å¿½ç•¥ XML å±æ€§
  parseTagValue: false,      // æ ‡ç­¾å€¼ä¿ç•™å­—ç¬¦ä¸²æ ¼å¼ï¼ˆä¸è‡ªåŠ¨è½¬æ¢ç±»å‹ï¼‰
  trimValues: true,          // å»é™¤æ ‡ç­¾å€¼å‰åç©ºç™½
  parseTrueNumberOnly: false,// ä¸å¼ºåˆ¶å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—
  // è‡ªå®šä¹‰æ ‡ç­¾å€¼å¤„ç†å™¨
  tagValueProcessor: (tagName, tagValue) => {
    if (tagName === 'tool_input') {
      // è§£æ XML ä¸­çš„ JSON å†…å®¹
      try {
        return JSON.parse(tagValue);
      } catch {
        // è§£æå¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯ä¸åŸå§‹å†…å®¹
        return { error: 'tool_input ä¸­çš„ JSON æ— æ•ˆ', raw: tagValue };
      }
    }
    return tagValue;
  }
});

// åŸºäºæ¨æµ‹çš„ XML è§£æå™¨é…ç½®
const llmXmlParser = new XMLParser({
  ignoreAttributes: true,    // å¿½ç•¥ XML å±æ€§
  parseTagValue: false,      // æ ‡ç­¾å€¼ä¿ç•™å­—ç¬¦ä¸²æ ¼å¼ï¼ˆä¸è‡ªåŠ¨è½¬æ¢ç±»å‹ï¼‰
  trimValues: true,          // å»é™¤æ ‡ç­¾å€¼å‰åç©ºç™½
  parseTrueNumberOnly: false,// ä¸å¼ºåˆ¶å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—
  // è‡ªå®šä¹‰æ ‡ç­¾å€¼å¤„ç†å™¨
  tagValueProcessor: (tagName, tagValue) => {
    if (tagName === 'tool_input') {
      // è§£æ XML ä¸­çš„ JSON å†…å®¹
      try {
        return JSON.parse(tagValue);
      } catch {
        // è§£æå¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯ä¸åŸå§‹å†…å®¹
        return { error: 'tool_input ä¸­çš„ JSON æ— æ•ˆ', raw: tagValue };
      }
    }
    return tagValue;
  }
});
```


### ç¥ç§˜çš„ plist è§£æå™¨
å¼•å…¥ `plist`ï¼ˆApple å±æ€§åˆ—è¡¨è§£æå™¨ï¼‰æš—ç¤ºå­˜åœ¨ macOS ä¸“å±ä¼˜åŒ–ï¼š
```javascript
// åŸºäºæ¨æµ‹çš„å¯èƒ½ç”¨é€”
async function loadMacOSConfig() {
  // è¯»å– macOS åå¥½è®¾ç½®æ–‡ä»¶
  const config = await plist.parse(
    await fs.readFile('~/Library/Preferences/com.anthropic.claude-code.plist')
  );
  return {
    apiKeys: config.APIKeys,         // å­˜å‚¨åœ¨é’¥åŒ™ä¸²ï¼ˆKeychainï¼‰ä¸­çš„å¼•ç”¨
    sandboxProfiles: config.SandboxProfiles, // æ²™ç®±é…ç½®
    ideIntegrations: config.IDEIntegrations   // IDE é›†æˆè®¾ç½®
  };
}

// åŸºäºæ¨æµ‹çš„å¯èƒ½ç”¨é€”
async function loadMacOSConfig() {
  // è¯»å– macOS åå¥½è®¾ç½®æ–‡ä»¶
  const config = await plist.parse(
    await fs.readFile('~/Library/Preferences/com.anthropic.claude-code.plist')
  );
  return {
    apiKeys: config.APIKeys,         // å­˜å‚¨åœ¨é’¥åŒ™ä¸²ï¼ˆKeychainï¼‰ä¸­çš„å¼•ç”¨
    sandboxProfiles: config.SandboxProfiles, // æ²™ç®±é…ç½®
    ideIntegrations: config.IDEIntegrations   // IDE é›†æˆè®¾ç½®
  };
}
```


### è·¨å¹³å°è¿›ç¨‹å¯åŠ¨
`cross-spawn` ä¾èµ–é¡¹ç”¨äºå¤„ç†ä¸åŒå¹³å°çš„è¿›ç¨‹å¯åŠ¨å·®å¼‚ï¼š
```javascript
// åŸºäºæ¨æµ‹çš„ MCP æœåŠ¡å™¨å¯åŠ¨æ¨¡å¼
function launchMCPServer(config) {
  const spawn = require('cross-spawn');
  
  const child = spawn(config.command, config.args, {
    stdio: ['pipe', 'pipe', 'pipe'], // æ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯æµé…ç½®
    env: {
      ...process.env,
      MCP_VERSION: '1.0' // ä¼ é€’ MCP ç‰ˆæœ¬ä¿¡æ¯
      // Windowsï¼šè‡ªåŠ¨å¤„ç† .cmd/.bat è„šæœ¬
      // Unixï¼šä¿ç•™è„šæœ¬ shebang è§£é‡Šå™¨æŒ‡å®š
    },
    shell: false,         // ç¦ç”¨ shell é¿å…æ³¨å…¥é£é™©
    windowsHide: true     // Windows å¹³å°éšè—æ§åˆ¶å°çª—å£
  });
  
  return new MCPStdioTransport(child); // è¿”å›æ ‡å‡† IO ä¼ è¾“å®ä¾‹
}

// åŸºäºæ¨æµ‹çš„ MCP æœåŠ¡å™¨å¯åŠ¨æ¨¡å¼
function launchMCPServer(config) {
  const spawn = require('cross-spawn');
  
  const child = spawn(config.command, config.args, {
    stdio: ['pipe', 'pipe', 'pipe'], // æ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯æµé…ç½®
    env: {
      ...process.env,
      MCP_VERSION: '1.0' // ä¼ é€’ MCP ç‰ˆæœ¬ä¿¡æ¯
      // Windowsï¼šè‡ªåŠ¨å¤„ç† .cmd/.bat è„šæœ¬
      // Unixï¼šä¿ç•™è„šæœ¬ shebang è§£é‡Šå™¨æŒ‡å®š
    },
    shell: false,         // ç¦ç”¨ shell é¿å…æ³¨å…¥é£é™©
    windowsHide: true     // Windows å¹³å°éšè—æ§åˆ¶å°çª—å£
  });
  
  return new MCPStdioTransport(child); // è¿”å›æ ‡å‡† IO ä¼ è¾“å®ä¾‹
}
```


## ä¾èµ–é¡¹å®‰å…¨è€ƒé‡
åŸºäºä¾èµ–é¡¹åˆ†æï¼Œå¯æç‚¼å‡ºä»¥ä¸‹å®‰å…¨æ¨¡å¼ï¼š

### 1. è¾“å…¥éªŒè¯å±‚çº§
```
ç”¨æˆ·è¾“å…¥ â†’ Zod æ¨¡å¼éªŒè¯ â†’ éªŒè¯åæ•°æ® â†’ å·¥å…·æ‰§è¡Œ
     â†“
  éªŒè¯å¤±è´¥ï¼ˆæ‹’ç»æ‰§è¡Œï¼‰
```

### 2. æ²™ç®±åŒ–ä¾èµ–é¡¹
- ä¸ç›´æ¥ä½¿ç”¨ `child_process`ï¼ˆæ”¹ç”¨ `cross-spawn` å°è£…ï¼‰
- ç¦ç”¨ `eval`ï¼ˆä»…åœ¨å—æ§å·¥ä½œçº¿ç¨‹ä¸­æœ‰é™ä½¿ç”¨ï¼‰
- æœªæ£€æµ‹åˆ°åŠ¨æ€ `require` æ¨¡å¼ï¼ˆé¿å…æ¶æ„æ¨¡å—åŠ è½½ï¼‰

### 3. å¯†é’¥ç®¡ç†
```javascript
// åŸºäºä¾èµ–é¡¹ç¼ºå¤±æ¨æµ‹çš„å¯†é’¥ç®¡ç†é€»è¾‘
class SecretManager {
  async getAPIKey(provider) {
    if (process.platform === 'darwin') {
      // macOSï¼šé€šè¿‡ N-API è°ƒç”¨ç³»ç»Ÿé’¥åŒ™ä¸²
      return await keychain.getPassword('claude-code', provider);
    } else {
      // å…¶ä»–å¹³å°ï¼šå›é€€åˆ°ç¯å¢ƒå˜é‡
      return process.env[`${provider.toUpperCase()}_API_KEY`];
    }
  }
}

// åŸºäºä¾èµ–é¡¹ç¼ºå¤±æ¨æµ‹çš„å¯†é’¥ç®¡ç†é€»è¾‘
class SecretManager {
  async getAPIKey(provider) {
    if (process.platform === 'darwin') {
      // macOSï¼šé€šè¿‡ N-API è°ƒç”¨ç³»ç»Ÿé’¥åŒ™ä¸²
      return await keychain.getPassword('claude-code', provider);
    } else {
      // å…¶ä»–å¹³å°ï¼šå›é€€åˆ°ç¯å¢ƒå˜é‡
      return process.env[`${provider.toUpperCase()}_API_KEY`];
    }
  }
}
```


## ä¾èµ–é¡¹é€‰æ‹©å¯¹æ€§èƒ½çš„å½±å“


### å†…å­˜ç®¡ç†ç­–ç•¥
ä¾èµ–é¡¹é€‰æ‹©ä½“ç°äº†ç²¾å¿ƒè®¾è®¡çš„å†…å­˜ç®¡ç†æ€è·¯ï¼š

| ç»„ä»¶ï¼ˆComponentï¼‰       | ç­–ç•¥ï¼ˆStrategyï¼‰ | å®ç°æ–¹å¼ï¼ˆImplementationï¼‰                  |
|-------------------------|-----------------|---------------------------------------------|
| æ–‡ä»¶è¯»å–                | æµå¼å¤„ç†        | `glob.stream`ã€åˆ†å—è¯»å–ï¼ˆchunked readsï¼‰     |
| å›¾ç‰‡å¤„ç†                | åŸç”Ÿå†…å­˜æ“ä½œ    | `sharp` ç»“åˆ libvipsï¼ˆä½¿ç”¨å †å¤–å†…å­˜ï¼‰         |
| XML è§£æ                | SAX é£æ ¼è§£æ    | åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œå†…å­˜å ç”¨æ’å®š                  |
| æ¨¡å¼åŒ¹é…                | ç¼–è¯‘ç¼“å­˜        | é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼                        |
| UI æ¸²æŸ“                 | è™šæ‹Ÿ DOM        | æœ€å°åŒ–ç»ˆç«¯æ›´æ–°æ“ä½œ                          |


### å¯åŠ¨æ—¶é—´ä¼˜åŒ–
ä¾èµ–é¡¹é‡‡ç”¨å»¶è¿ŸåŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰ç»“æ„ï¼š
```javascript
// åŸºäºæ¨æµ‹çš„å»¶è¿ŸåŠ è½½æ¨¡å¼
const LAZY_DEPS = {
  'sharp': () => require('sharp'),
  '@aws-sdk/client-bedrock-runtime': () => require('@aws-sdk/client-bedrock-runtime'),
  'google-auth-library': () => require('google-auth-library')
};

function getLazyDep(name) {
  // ç¼“å­˜å·²åŠ è½½çš„ä¾èµ–é¡¹
  if (!LAZY_DEPS[name]._cached) {
    LAZY_DEPS[name]._cached = LAZY_DEPS[name]();
  }
  return LAZY_DEPS[name]._cached;
}

// åŸºäºæ¨æµ‹çš„å»¶è¿ŸåŠ è½½æ¨¡å¼
const LAZY_DEPS = {
  'sharp': () => require('sharp'),
  '@aws-sdk/client-bedrock-runtime': () => require('@aws-sdk/client-bedrock-runtime'),
  'google-auth-library': () => require('google-auth-library')
};

function getLazyDep(name) {
  // ç¼“å­˜å·²åŠ è½½çš„ä¾èµ–é¡¹
  if (!LAZY_DEPS[name]._cached) {
    LAZY_DEPS[name]._cached = LAZY_DEPS[name]();
  }
  return LAZY_DEPS[name]._cached;
}
```


æœ¬ä¾èµ–é¡¹åˆ†æåŸºäºåç¼–è¯‘ä¸é€†å‘å·¥ç¨‹å¾—å‡ºï¼Œå®é™…å®ç°ç»†èŠ‚å¯èƒ½å­˜åœ¨å·®å¼‚ã€‚æ–‡ä¸­å‘ˆç°çš„æ¨¡å¼ä¸æ´å¯Ÿï¼Œå‡æ˜¯ç»“åˆ Node.js ç”Ÿæ€å¸¸è§å®è·µä¸å¯è§‚æµ‹è¡Œä¸ºï¼Œå¯¹æ¶æ„å†³ç­–åšå‡ºçš„æ¨æµ‹ã€‚









