https://www.anthropic.com/engineering/writing-tools-for-agents


# 为AI智能体编写高效工具——Anthropic网页总结
## 一、核心观点
智能体的有效性取决于其所用工具，本文围绕如何借助Claude等智能体编写高质量AI智能体工具、开展评估及优化性能展开，介绍了工具开发流程与关键原则，强调需将软件开发模式从确定性转向非确定性以适配智能体特性。

## 二、工具的定义与特性
1. **定义**：工具是连接确定性系统（如传统软件）与非确定性系统（如AI智能体）的新型软件，反映二者间的约定。例如用户问“今天该带伞吗”，智能体可能调用天气工具、凭常识回答或先询问地点，且可能出现“幻觉”或不会使用工具的情况。
2. **与传统软件差异**：传统软件函数（如`getWeather(“NYC”)`）输入相同则输出必同，而工具需适配智能体的非确定性，不能按为其他开发者或系统写函数、API的方式设计，需重新调整开发思路。

## 三、工具编写流程
### （一）构建原型
1. 先搭建简易工具原型并本地测试，因不实际体验难判断智能体对工具的“易用性”。
2. 若用Claude Code编写工具，需提供工具依赖的软件库、API、SDK（含MCP SDK）文档，适配大模型的文档常存于官方网站的`llms.txt`文件。
3. 可通过本地MCP服务器、桌面扩展程序（DXT）或直接传入Anthropic API调用，实现工具与Claude Code、Claude桌面应用的连接测试，同时亲自测试并收集用户反馈以完善工具。

### （二）进行评估
1. **生成评估任务**
    - 借助早期原型，让Claude Code生成数十对基于真实应用场景（如内部知识库、微服务）的提示词与响应，避免简单“沙盒”环境，优质任务可能需多次（甚至数十次）工具调用。
    - 优质任务示例：下周安排与简讨论Acme Corp最新项目的会议，附上次项目规划会议笔记并预订会议室；客户ID 9182反馈单次购买被收费三次，需找出相关日志并确认是否有其他客户受影响等。
    - 次要任务示例：安排下周与jane@acme.corp的会议；在支付日志中搜索`purchase_complete`和`customer_id=9182`等。
    - 每个评估提示需搭配可验证结果，验证器可简单如字符串对比，也可借助Claude判断，且要避免因格式、标点等无关差异拒绝正确响应。
2. **运行评估**
    - 通过直接调用LLM API编程运行评估，用`while`循环构建智能体循环（交替进行LLM API调用与工具调用），每个评估任务对应一个循环，给评估智能体分配单一任务提示与工具。
    - 在评估智能体系统提示中，要求其输出结构化响应块（用于验证）、推理和反馈块，且在工具调用和响应块前输出，可触发思维链（CoT）行为提升LLM智能；用Claude评估时可开启“交错思维”功能，探究智能体工具使用原因并找出工具描述和规格的改进点。
    - 除准确性外，还需收集单个工具调用与任务的总运行时间、工具调用总数、总令牌消耗、工具错误等指标，以了解智能体工作流程并为工具整合提供方向。
3. **分析结果**
    - 智能体可协助发现工具问题（如描述矛盾、实现低效、架构混乱），但需注意其反馈中省略的内容可能更关键，且LLM未必“言出必行”。
    - 观察智能体困惑点，阅读其推理、反馈（或CoT）及原始记录（含工具调用与响应），挖掘未明确描述的行为，同时需知晓评估智能体未必掌握正确答案与策略。
    - 分析工具调用指标，如大量冗余调用可能需调整分页或令牌限制参数，大量参数无效错误可能需优化工具描述或示例，例如Claude的网络搜索工具曾因不必要附加`2025`到`query`参数导致结果偏差，后通过改进描述解决。

### （三）与智能体协作
1. 将评估智能体的记录拼接后粘贴到Claude Code，其可分析记录并批量重构工具，确保工具实现与描述在更改后保持自洽。
2. 本文多数建议源于用Claude Code反复优化内部工具实现，评估基于内部工作区构建，模拟真实项目、文档、消息等复杂流程。
3. 借助留出的测试集避免过度拟合“训练”评估，测试表明即便超出“专家级”工具（研究人员手动编写或Claude生成）的成果，仍能进一步提升性能。

## 四、编写高效工具的原则
### （一）选择合适工具
1. 工具并非越多越好，避免仅包装现有软件功能或API端点却不考虑是否适配智能体，因智能体对工具可执行操作的感知方式与传统软件不同。
2. 考虑智能体“上下文”有限的特点，例如通讯录工具，传统软件可逐行处理联系人列表，而智能体若用返回所有联系人的工具，会浪费上下文空间，应选择`search_contacts`（搜索联系人）或`message_contact`（给联系人发消息）而非`list_contacts`（列出联系人）。
3. 工具可整合功能，在后台处理多个独立操作或API调用，例如用`schedule_event`（安排活动）工具替代`list_users`（列出用户）、`list_events`（列出活动）、`create_event`（创建活动）工具，用`search_logs`（搜索日志）工具替代`read_logs`（读取日志）工具，用`get_customer_context`（获取客户上下文）工具替代`get_customer_by_id`（通过ID获取客户）、`list_transactions`（列出交易）、`list_notes`（列出备注）工具。
4. 确保工具用途明确独特，能让智能体像人类一样细分任务，同时减少中间输出占用的上下文，避免过多或功能重叠的工具干扰智能体选择高效策略。

### （二）为工具设置命名空间
1. 智能体可能访问大量工具（含其他开发者开发的），功能重叠或用途模糊的工具会让其困惑，命名空间（将相关工具归到共同前缀下）可划分工具界限，MCP客户端有时默认如此操作。
2. 示例：按服务（如`asana_search`、`jira_search`）或资源（如`asana_projects_search`、`asana_users_search`）划分命名空间，帮助智能体正确选择工具。
3. 基于前缀和后缀的命名空间对工具使用评估影响显著，且因LLM而异，需根据自身评估选择命名方案。
4. 选择名称反映任务自然细分的工具，可减少加载到智能体上下文的工具及描述数量，将智能体计算任务转移到工具调用本身，降低智能体出错风险。

### （三）从工具返回有意义的上下文
1. 工具仅返回高价值信息，优先考虑上下文相关性而非灵活性，避免使用低级技术标识符（如`uuid`、`256px_image_url`、`mime_type`），`name`（名称）、`image_url`（图片链接）、`file_type`（文件类型）等字段更能为智能体后续行动提供指导。
2. 智能体处理自然语言名称、术语或标识符的能力优于晦涩标识符，将字母数字UUID转换为语义清晰的表述（或0索引ID方案），可减少“幻觉”并提升Claude在检索任务中的精度。
3. 部分场景下，智能体需灵活处理自然语言与技术标识符输出以触发下游工具调用（如`search_user(name=’jane’)`→`send_message(id=12345)`），可在工具中设置`response_format`枚举参数，让智能体控制返回“简洁”（`concise`）或“详细”（`detailed`）响应，也可添加更多格式提升灵活性（类似GraphQL）。
4. 工具响应结构（如XML、JSON、Markdown）对评估性能有影响，因LLM基于下一个token预测训练，适配训练数据格式时表现更佳，且最佳结构因任务和智能体而异，需根据自身评估选择。

### （四）优化工具响应以提高令牌效率
1. 对可能占用大量上下文的工具响应，结合使用分页、范围选择、过滤、截断，并设置合理默认参数，例如Claude Code默认将工具响应限制在25000个令牌内，且预计未来智能体有效上下文长度增加，但对上下文高效工具的需求仍存在。
2. 若截断响应，需用有用指令引导智能体，例如鼓励在知识检索任务中进行多次小型定向搜索而非单次宽泛搜索；工具调用出错（如输入验证时），需通过提示工程设计错误响应，清晰传达具体可操作的改进建议，而非使用模糊错误代码或回溯信息。

### （五）对工具描述进行提示词工程处理
1. 撰写工具描述和规格时，如同向团队新成员介绍工具，明确隐含背景信息（如专业查询格式、小众术语定义、底层资源关系），通过清晰描述（并借助严格数据模型确保）预期输入输出避免歧义，输入参数命名需明确（如用`user_id`而非`user`）。
2. 借助评估可准确衡量提示词工程的影响，即使微小的工具描述改进也可能带来显著效果，例如对工具描述精确优化后，Claude Sonnet 3.5在SWE-bench Verified评估中表现出色，大幅降低错误率并提升任务完成度。
3. 可在《开发者指南》中获取工具定义的其他最佳实践；为Claude开发工具时，需了解工具如何动态加载到其“系统提示词”；为MCP服务器编写工具时，“工具注释”可说明哪些工具需开放世界访问权限或会产生破坏性更改。

## 五、展望未来
1. 构建有效的智能体工具需将软件开发实践从可预测、确定性模式转向非确定性模式。
2. 成功工具的共性：定义明确且精心设计、审慎利用智能体上下文、可在多样化工作流中组合使用、能让智能体直观解决现实任务，这些模式源于文中所述的迭代式、评估导向流程。
3. 未来智能体与世界交互的具体机制（如MCP协议更新、基础LLM升级）将不断发展，通过系统性、评估导向的工具改进方法，可确保工具随智能体能力增强而同步进化。

## 六、其他信息
1. **致谢**：本文由Ken Aizawa撰写，Anthropic公司多个部门（研究、MCP、产品工程、市场、设计、应用AI）的同事提供了宝贵贡献。
2. **学习资源**：可通过Anthropic学院的课程学习API开发、模型上下文协议（MCP）、Claude Code，完成课程可获得证书。
3. **订阅通讯**：提供邮箱可订阅每月开发者通讯，获取产品更新、操作指南、社区焦点等内容，且可随时取消订阅。
4. **相关链接**：包含Anthropic的产品（如Claude、Claude Code、不同付费计划）、模型（如Opus、Sonnet、Haiku）、解决方案（如AI智能体、代码现代化、客户支持）、开发者平台、学习资源、公司信息、帮助与安全、条款与政策等链接。
